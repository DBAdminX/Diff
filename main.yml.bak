name: Build and Release

on:
  push:
    # OR A||B
    #branches:
      #- main
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  pyinstaller-build:
    runs-on: windows-latest
    steps:
      - name: Create Executable
        uses: sayyid5416/pyinstaller@v1
        with:
          python_ver: 3.11
          spec: 'src/diff.py'
          upload_exe_with_name: 'Diff'
          options: --onefile, --name "Diff", --windowed,
      - name: Download Zip
        uses: actions/download-artifact@v4
        with:
          name: Diff
      - name: Compile .ISS to .EXE Installer
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.2
        with:
          path: setup.iss
          options: /O+
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./Output/Diff.exe
          asset_name: Diff.exe
          tag: ${{ github.ref }}
          overwrite: true
          body: "This is my release text"
  publish-to-winget:
    runs-on: windows-latest
    needs: pyinstaller-build   # Only run after successful build & release upload
    if: startsWith(github.ref, 'refs/tags/v')   # extra safety

    steps:
      - name: Get version from tag
        id: get-version
        run: |
          # Finding the version from release name
          $VERSION="${{ github.event.release.name }}" -replace '^.*/ '
          "version=$VERSION" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Publish to WinGet
        uses: vedantmgoyal9/winget-releaser@main
        with:
          identifier: DBAdminX.Diff      # ‚Üê REQUIRED: change to your real WinGet identifier (e.g. JanLunge.DiffTool)
          version: ${{ steps.get-version.outputs.version }}
          token: ${{ secrets.WINGET_TOKEN }}   # Personal Access Token with repo scope for winget-pkgs fork
          # Optional but recommended:
          # installers-regex: '\.exe$'               # only match .exe files
          # max-versions-to-keep: 3

